# Template file for 'asahi-uboot'
pkgname=asahi-uboot
version=2024.04
revision=1
_subversion=1
archs="aarch64*"
hostmakedepends="flex bc dtc openssl-devel" # until uboot supports skipping tools build...
short_desc="U-Boot for Apple Silicon Macs"
maintainer="Will Springer <skirmisher@protonmail.com>, dkwo <npiazza@disroot.org>"
license="GPL-2.0-or-later, MIT"
homepage="http://asahilinux.org"
distfiles="https://github.com/AsahiLinux/u-boot/archive/refs/tags/asahi-v${version}-${_subversion}.tar.gz"
checksum=40d8fb513ba332c798510e003e9d63ce6a392e2777398ec260f20678502b3a71

do_configure() {
	unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS
	make ${makejobs} apple_m1_defconfig
}

do_build() {
	unset CFLAGS CXXFLAGS CPPFLAGS LDFLAGS
	if [ "$CROSS_BUILD" ]; then
	        export CROSS_COMPILE=${XBPS_CROSS_TRIPLET}-
	fi
	make ${makejobs} EXTRAVERSION=-${revision}
}

do_install() {
	vinstall u-boot-nodtb.bin 0644 usr/lib/asahi-boot
	for dtb in arch/arm/dts/t[86]*.dtb ; do
		vinstall ${dtb} 0644 usr/lib/asahi-boot/dtb
	done

	vlicense Licenses/Exceptions
	vlicense Licenses/OFL.txt
	vlicense Licenses/README
	vlicense Licenses/bsd-2-clause.txt
	vlicense Licenses/bsd-3-clause.txt
	vlicense Licenses/eCos-2.0.txt
	vlicense Licenses/gpl-2.0.txt
	vlicense Licenses/ibm-pibs.txt
	vlicense Licenses/isc.txt
	vlicense Licenses/lgpl-2.0.txt
	vlicense Licenses/lgpl-2.1.txt
	vlicense Licenses/r8a779x_usb3.txt
	vlicense Licenses/x11.txt
}
