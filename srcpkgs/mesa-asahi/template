# Template file for 'mesa-asahi'
pkgname=mesa-asahi
version=24.2.0
revision=1
_asahiver=20240527
build_style=meson
build_helper=qemu
_llvmver=17
#Disable LTO flag should be present, see https://gitlab.freedesktop.org/mesa/mesa/-/issues/6911
configure_args="-Dglvnd=enabled -Dshared-glapi=enabled -Dgbm=enabled -Degl=enabled
 -Dosmesa=true -Dgles1=enabled -Dgles2=enabled -Dglx=dri -Ddri3=enabled
 -Dlmsensors=enabled -Dplatforms=x11$(vopt_if wayland ,wayland)
 -Dllvm=enabled -Db_lto=false -Dcpp_std=gnu++17"
hostmakedepends="gettext flex pkg-config python3-Mako glslang llvm${_llvmver}
 $(vopt_if wayland 'wayland-protocols wayland-devel')"
makedepends="elfutils-devel expat-devel libXdamage-devel
 libXxf86vm-devel libdrm-devel libffi-devel libva-devel
 libvdpau-devel libxshmfence-devel ncurses-devel zlib-devel
 $(vopt_if wayland 'wayland-devel wayland-protocols') llvm${_llvmver}-devel libsensors-devel
 libXrandr-devel libglvnd-devel libzstd-devel libxml2-devel lua53-devel
 libarchive-devel python3-pycparser"
depends="libglvnd"
short_desc="Open source implementation of OpenGL and Vulkan - Asahi"
maintainer="Orphaned <orphan@voidlinux.org>"
license="MIT, LGPL-2.1-or-later"
homepage="https://www.mesa3d.org/"
changelog="https://docs.mesa3d.org/relnotes.html"
distfiles="https://gitlab.freedesktop.org/asahi/mesa/-/archive/asahi-${_asahiver}/mesa-asahi-${_asahiver}.tar.gz"
checksum=aca4991240f3d25617762d0c8b9644ad05e3b45791bb81f048fc304d44260fe0
conflicts="mesa"

build_options="wayland"
build_options_default="wayland"

# Set subpackages manually
subpackages="libgbm-asahi libgbm-asahi-devel libOSMesa-asahi mesa-asahi-vaapi mesa-asahi-vdpau
 mesa-asahi-vulkan-overlay-layer mesa-asahi-dri MesaLib-asahi-devel"

# Replace old mesa pkgs, superseded by libglvnd.
replaces="libGL>=10_1<19.2.5_2 libEGL>=10_1<19.2.5_2 libGLES>=10_1<19.2.5_2"

# Driver configuration
# Check for correctness on major mesa version updates
# Particularly, check if any new worthwhile drivers were added

# swrast always present
_gallium_drivers=" -Dgallium-drivers=swrast,asahi,virgl,zink"
_vulkan_drivers=" -Dvulkan-drivers=swrast,virtio"

configure_args+=" -Dgallium-vdpau=enabled -Dgallium-va=enabled ${_vulkan_drivers} -Dvulkan-layers=device-select,overlay"
configure_args+=" ${_gallium_drivers}"
makedepends+=" vulkan-loader"

hostmakedepends+=" clang${_llvmver} rust rust-bindgen"
makedepends+=" clang${_llvmver} libclc rust SPIRV-LLVM-Translator-devel SPIRV-Tools-devel"
subpackages+=" mesa-asahi-opencl"
configure_args+=" -Dgallium-opencl=icd -Dgallium-rusticl=true -Drust_std=2021"

post_configure() {
	if [ "$CROSS_BUILD" ]; then
		find -iname "*.ninja" -exec sed -i "{}" \
			-e "/rustc/s; --sysroot ${XBPS_CROSS_BASE}/usr;;g" \
			-e "s|-isystem/usr/include||g" \
		\;
	fi
}

post_install() {
	vlicense docs/license.rst

	# ensure that each eligible architecture ships its multilib icd files
	# in some cases, multiple counterpart architectures may exist (aarch64)
	# this allows us to not have to ship these files in the current *-32bit packages
	local arch=${XBPS_TARGET_MACHINE%-*}
	local oarchs
	local olibdir="/usr/lib32/"
	if [ "$XBPS_TARGET_WORDSIZE" = "32" ]; then
		olibdir="/usr/lib64/"
	fi
	oarchs="armv6l armv7l"
	for oarch in $oarchs; do
		for icd in ${DESTDIR}/usr/share/vulkan/icd.d/*_icd.${arch}.json; do
			sed "s#/usr/lib${XBPS_TARGET_WORDSIZE}/#${olibdir}#g" \
				${icd} > ${icd/.${arch}/.${oarch}}
		done
	done
}

libgbm-asahi_package() {
	short_desc="Mesa Generic buffer management API - runtime"
	conflicts="libgbm"
	shlib_provides="libgbm.so"
	pkg_install() {
		vmove "usr/lib/libgbm.so.*"
	}
}

libgbm-asahi-devel_package() {
	short_desc="Mesa Generic buffer management API - development files"
	depends="libgbm-asahi>=${version}_${revision}"
	conflicts="libgbm-devel"
	pkg_install() {
		vmove usr/include/gbm.h
		vmove usr/lib/libgbm.so
		vmove usr/lib/pkgconfig/gbm.pc
	}
}

libOSMesa-asahi_package() {
	short_desc="Mesa Off-Screen interface library"
	conflicts="libOSMesa"
	pkg_install() {
		vmove "usr/lib/libOSMesa.so.*"
	}
}

MesaLib-asahi-devel_package() {
	depends="mesa-asahi>=${version}_${revision} libOSMesa-asahi>=${version}_${revision}
	libgbm-asahi-devel>=${version}_${revision}"
	depends+=" libdrm-devel libglvnd-devel"
	conflicts="MesaLib-devel"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/lib/libEGL_mesa.so
		vmove usr/lib/libGLX_mesa.so
		vmove usr/lib/libOSMesa.so
		vmove usr/lib/libglapi.so
	}
}

mesa-asahi-dri_package() {
	short_desc="Mesa DRI drivers"
	depends="mesa-asahi-${version}_${revision}"
	conflicts="mesa-dri"
	shlib_provides="libgallium_dri.so" # workaround for mesa-dri-32bit
	pkg_install() {
		vmove usr/lib/dri
	}
}

mesa-asahi-opencl_package() {
	short_desc="Mesa implementation of OpenCL (r600+ only)"
	depends="libclc"
	conflicts="mesa-opencl"
	pkg_install() {
		vmove etc/OpenCL
		vmove usr/lib/gallium-pipe
		vmove "usr/lib/libMesaOpenCL.so.*"
		vmove "usr/lib/libRusticlOpenCL.so.*"
	}
}

mesa-asahi-vaapi_package() {
	short_desc="Mesa VA-API drivers"
	conflicts="mesa-vaapi"
	shlib_provides="libgallium_drv_video.so" # workaround for mesa-vaapi-32bit
	pkg_install() {
		vmove "usr/lib/dri/*_drv_video.so"
	}
}

mesa-asahi-vdpau_package() {
	short_desc="Mesa VDPAU drivers"
	conflicts="mesa-vdpau"
	pkg_install() {
		vmove "usr/lib/vdpau/libvdpau_*"
	}
}

mesa-asahi-vulkan-overlay-layer_package() {
	short_desc="Vulkan layer to display information about the running application"
	conflicts="mesa-vulkan-overlay-layer"
	pkg_install() {
		vmove "usr/share/vulkan/explicit_layer.d/VkLayer_*.json"
		vmove "usr/share/vulkan/implicit_layer.d/VkLayer_*.json"
		vmove "usr/bin/mesa-overlay-control.py"
		vmove "usr/lib/libVkLayer_*.so"
	}
}
